{% extends 'base.html' %}
{% block head_extra %}

<style>
  /* Contenedor estable para las gráficas */
  .chart-wrap{
    position: relative;
    height: 320px;      /* ajusta a gusto (240–360px) */
    width: 100%;
    overflow: hidden;   /* evita desbordes que crean scroll */
  }

  /* El canvas rellena el contenedor sin cambiar su altura */
  .chart-wrap > canvas{
    position: absolute;
    inset: 0;
    width: 100% !important;
    height: 100% !important;
    display: block;
  }

  /* Por si la card intenta crecer: */
  .card .card-body{ overflow: hidden; }
</style>


{% endblock %}
{% block title %}Dashboard de Comerciales{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Dashboard de Comerciales</h3>
    <div class="text-muted small">• Información</div>
  </div>
  <div class="d-flex gap-2">
    <select id="filtroCom" class="form-select form-select-sm" style="min-width:260px;">
  <option value="">Todos los comerciales</option>
  {% for u in comerciales %}
    <option value="{{ u.email }}">
      {{ (u.nombre_completo or u.email.split('@')[0]) }}
      {% if u.role and u.role.name == 'jefe_grupo' %} (Jefe){% endif %}
      {% for gm in u.grupo_miembros if gm.es_lider %}{% if loop.first %} (Líder){% endif %}{% endfor %}
    </option>
  {% endfor %}
</select>


  </div>
</div>

<!-- Tarjetas -->
<div class="row g-3">
  <div class="col-12 col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-muted small">Ingreso total</div>
        <div class="fs-4 fw-semibold" id="m_ingreso">$ 0</div>
        <div class="small text-muted">Periodo: 12 semanas</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-muted small">Clientes entrados</div>
        <div class="fs-4 fw-semibold" id="m_entrados">0</div>
        <div class="small text-muted" id="m_vs">Leads: 0 | Cerrados: 0</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-muted small">Leads (Posible cliente)</div>
        <div class="fs-4 fw-semibold" id="m_bajas">0</div>
        <div class="small text-muted">Netos: <span id="m_netos">0</span></div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-muted small">Tasa de cierre</div>
        <div class="fs-4 fw-semibold" id="m_cierre">0%</div>
        <div class="small text-muted">Solo cuenta “Cerrado”</div>
      </div>
    </div>
  </div>
</div>



<!-- Linea -->
<div class="fw-semibold mb-2">Ingreso por semana</div>
<div class="chart-wrap">
  <canvas id="chartLine"></canvas>
</div>

<!-- Barras -->
<div class="fw-semibold mb-2">Entrados vs Leads vs Cerrados</div>
<div class="chart-wrap">
  <canvas id="chartBar"></canvas>
</div>

<!-- Tabla comerciales por grupo -->
<div class="card shadow-sm border-0 mt-3">
  <div class="card-body">
    <div class="fw-semibold mb-2">Comerciales por grupo</div>
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>Comercial</th><th>Grupo</th>
            <th>Ingreso</th><th>Entrados</th><th>Leads</th>
            <th>Cerrados</th><th>Cierre</th>
          </tr>
        </thead>
        <tbody id="tb_grupo"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Top 5 -->
<div class="card shadow-sm border-0 mt-3">
  <div class="card-body">
    <div class="fw-semibold mb-2">Top 5 por ingreso</div>
    <div id="top5_list" class="d-flex flex-column gap-2"></div>
  </div>
</div>
{% endblock %}




{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  const $ = (s,r=document)=>r.querySelector(s);
  const dinero = v => '$ ' + (Number(v||0).toLocaleString());

  let lineChart=null, barChart=null;

  async function loadDashboard(){
    const com = $('#filtroCom')?.value || '';
    const r = await fetch(`/api/dashboard?com=${encodeURIComponent(com)}`);
    if(!r.ok){
      console.error('Error API dashboard', r.status);
      return;
    }
    const j = await r.json();

    // Métricas (nuevas claves)
    $('#m_ingreso').textContent = dinero(j.ingreso_total);
    $('#m_entrados').textContent = j.entrados_total;
    $('#m_bajas').textContent = j.bajas_total;              // Leads
    const cerr = j.cerrados_total || 0;
    $('#m_vs').textContent = `Leads: ${j.bajas_total} | Cerrados: ${cerr}`;
    const netos = (j.entrados_total - j.bajas_total);
    $('#m_netos').textContent = netos;
    $('#m_cierre').textContent = (j.tasa_cierre || 0).toFixed(1) + '%';

    // Linea ingresos
    const lbls = j.series.labels;
    const dataLine = j.series.ingresos_por_semana;
    if(lineChart) { lineChart.destroy(); }
    lineChart = new Chart($('#chartLine'), {
      type: 'line',
      data: {
        labels: lbls,
        datasets: [{
          label: 'Ingresos',
          data: dataLine,
          tension: .35
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins:{ legend:{display:false}},
        scales:{ y:{ beginAtZero:true } }
      }
    });

    // Barras Entrados vs Leads vs Cerrados
    if(barChart) { barChart.destroy(); }
    barChart = new Chart($('#chartBar'), {
      type: 'bar',
      data: {
        labels: lbls,
        datasets: [
          { label:'Entrados', data: j.series.entrados },
          { label:'Leads',    data: j.series.bajas },
          { label:'Cerrados', data: j.series.cerrados }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins:{ legend:{ position:'top' } },
        scales:{ y:{ beginAtZero:true } }
      }
    });

    // Tabla por grupo
    const tb = $('#tb_grupo');
    tb.innerHTML = '';
    (j.comerciales_por_grupo || []).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.comercial}</td>
        <td><span class="badge text-bg-light">${r.grupo}</span></td>
        <td>${dinero(r.ingreso)}</td>
        <td>${r.entrados}</td>
        <td>${r.bajas}</td>
        <td>${r.cerrados}</td>
        <td>${r.cierre}</td>`;
      tb.appendChild(tr);
    });

    // Top 5
    const cont = $('#top5_list');
    cont.innerHTML = '';
    (j.top5 || []).forEach((x, i)=>{
      const div = document.createElement('div');
      div.className = "d-flex justify-content-between align-items-center border rounded p-2";
      div.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <div class="badge rounded-circle text-bg-secondary" style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;">${i+1}</div>
          <div>
            <div class="fw-semibold">${x.nombre}</div>
            <div class="small text-muted">${x.email || ''}</div>
          </div>
        </div>
        <div class="fw-semibold">${dinero(x.ingreso)}</div>`;
      cont.appendChild(div);
    });
  }

  $('#filtroCom')?.addEventListener('change', loadDashboard);
  // redimensiona charts si el contenedor cambia
  window.addEventListener('resize', () => {
    lineChart?.resize();
    barChart?.resize();
  });

  loadDashboard();
})();
</script>
{% endblock %}
