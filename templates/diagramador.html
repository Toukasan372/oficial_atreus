<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Diagramador Moderno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f8fafc; --panel:#f1f5f9; --border:#e2e8f0; --text:#1e293b;
      --grid:#e2e8f0; --ctx-bg:#fff; --ctx-hover:#f1f5f9; --primary:#2563eb;
    }
    body.dark {
      --bg:#0f172a; --panel:#1e293b; --border:#334155; --text:#e2e8f0;
      --grid:#1e293b; --ctx-bg:#1e293b; --ctx-hover:#334155;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
    header{grid-column:1/3;display:flex;align-items:center;gap:.75rem;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--panel)}
    header h1{font-size:18px;margin:0;font-weight:700}
    .spacer{flex:1}
    .btn-top{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--ctx-bg);cursor:pointer;font-size:13px}
    .btn-top.primary{border-color:var(--primary);color:#fff;background:var(--primary)}
    .sidebar{background:var(--panel);border-right:1px solid var(--border);padding:12px;overflow:auto}
    .section{margin-bottom:16px}
    .section h3{margin:0 0 8px;font-size:12px;font-weight:700;color:#64748b}
    body.dark .section h3{color:#94a3b8}
    .btn{display:block;width:100%;padding:8px;margin-bottom:6px;border:1px solid var(--border);border-radius:8px;background:var(--ctx-bg);cursor:pointer;font-size:13px;text-align:left;transition:.15s;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .btn:hover{background:var(--ctx-hover)}
    .canvas-wrap{position:relative;overflow:hidden}
    svg.canvas{width:100%;height:calc(100vh - 52px);display:block;background-image:
      linear-gradient(var(--grid) 1px,transparent 1px),
      linear-gradient(90deg,var(--grid) 1px,transparent 1px);
      background-size:20px 20px;cursor:grab}
    svg.canvas:active{cursor:grabbing}
    #inlineEdit{position:absolute;display:none;z-index:30;padding:6px 8px;border-radius:6px;border:1px solid var(--border);outline:none;background:var(--ctx-bg);color:var(--text);font-size:13px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    #ctx{position:absolute;display:none;z-index:40;min-width:170px;background:var(--ctx-bg);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.15)}
    #ctx button{all:unset;display:block;width:100%;padding:8px 10px;cursor:pointer;font-size:13px;color:var(--text)}
    #ctx button:hover{background:var(--ctx-hover)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Diagramador Moderno</h1>
      <span style="font-size:13px;opacity:.7;">Doble clic para renombrar • Clic derecho menú</span>
      <div class="spacer"></div>
      <button id="saveCloud" class="btn-top">💾 Guardar diagrama</button>
      <button id="toggleMode" class="btn-top">🌙 Modo oscuro</button>
      <a href="/inicio" class="btn-top">↩️ Volver</a>
    </header>

    <aside class="sidebar">
      <div class="section">
        <h3>Formas</h3>
        <button class="btn" data-add="rect">⬛ Rectángulo</button>
        <button class="btn" data-add="circle">⚪ Círculo</button>
        <button class="btn" data-add="diamond">◆ Rombo</button>
        <button class="btn" data-add="note">📝 Nota</button>
      </div>

      <div class="section">
        <h3>Acciones</h3>
        <button id="connectBtn" class="btn">🔗 Conectar</button>
        <button id="exportPNG" class="btn">📤 Exportar PNG</button>
        <button id="exportSVG" class="btn">📤 Exportar SVG</button>
        <button id="exportJSON" class="btn">📤 Exportar JSON</button>
        <button id="importJSON" class="btn">📥 Importar JSON</button>
      </div>
    </aside>

    <main class="canvas-wrap">
      <input id="inlineEdit" />
      <div id="ctx">
        <button id="ctxEdit">✏️ Editar texto</button>
        <button id="ctxColor">🎨 Cambiar color</button>
        <button id="ctxDup">📄 Duplicar</button>
        <button id="ctxDelete">🗑️ Eliminar</button>
        <button id="ctxConnect">🔗 Conectar desde aquí</button>
      </div>

      <svg id="svg" class="canvas" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <marker id="arrow" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
            <path d="M0,0 L12,6 L0,12 z" fill="#475569"/>
          </marker>
        </defs>
        <g id="edges"></g>
        <g id="nodes"></g>
      </svg>
    </main>
  </div>

  <script>
    // ---------- Estado y utilidades ----------
    const state={nodes:[],edges:[],idSeq:1,connectMode:false,connectFrom:null};
    const svg=document.getElementById("svg"),
          gNodes=document.getElementById("nodes"),
          gEdges=document.getElementById("edges");
    const inlineEdit=document.getElementById("inlineEdit"),
          ctx=document.getElementById("ctx"); let ctxTarget=null;

    const NEGOCIO_ID = {{ negocio_id|int }};

    function uuid(p){return p+"_"+(state.idSeq++);}
    function elNS(t,a={}){const e=document.createElementNS("http://www.w3.org/2000/svg",t);for(const k in a)e.setAttribute(k,a[k]);return e;}
    function getSVGPoint(evt){const pt=svg.createSVGPoint();pt.x=evt.clientX;pt.y=evt.clientY;return pt.matrixTransform(svg.getScreenCTM().inverse());}

    // ---------- Nodos ----------
    function addNode(type,x=100,y=100,label){
      const presets={
        rect:{w:140,h:70,label:"Rectángulo",fill:"#93c5fd"},
        circle:{w:100,h:100,label:"Círculo",fill:"#fda4af"},
        diamond:{w:120,h:120,label:"Rombo",fill:"#fcd34d"},
        note:{w:140,h:100,label:"Nota",fill:"#fef9c3"}
      };
      const p=presets[type]||presets.rect;
      const n={id:uuid("n"),type,x,y,w:p.w,h:p.h,label:label||p.label,fill:p.fill};
      state.nodes.push(n); drawNode(n); return n;
    }

    function drawNode(n){
      let g=document.getElementById(n.id);
      if(!g){
        g=elNS("g",{id:n.id}); gNodes.appendChild(g);
        g.addEventListener("mousedown",(e)=>startDrag(e,n));
        g.addEventListener("dblclick",()=>startEdit(n));
        g.addEventListener("contextmenu",(e)=>showCtx(e,n));
      }else{ g.innerHTML=""; }

      if(n.type==="circle"){
        g.appendChild(elNS("circle",{cx:n.x+n.w/2,cy:n.y+n.h/2,r:n.w/2,fill:n.fill,stroke:"#475569"}));
      }else if(n.type==="diamond"){
        g.appendChild(elNS("polygon",{points:`${n.x+n.w/2},${n.y} ${n.x+n.w},${n.y+n.h/2} ${n.x+n.w/2},${n.y+n.h} ${n.x},${n.y+n.h/2}`,fill:n.fill,stroke:"#475569"}));
      }else if(n.type==="note"){
        const path=`M${n.x},${n.y} h${n.w-20} l20,20 v${n.h-20} h-${n.w} z`;
        g.appendChild(elNS("path",{d:path,fill:n.fill,stroke:"#eab308"}));
        g.appendChild(elNS("polyline",{points:`${n.x+n.w-20},${n.y} ${n.x+n.w-20},${n.y+20} ${n.x+n.w},${n.y+20}`,fill:"#fef08a",stroke:"#eab308"}));
      }else{
        g.appendChild(elNS("rect",{x:n.x,y:n.y,width:n.w,height:n.h,rx:10,fill:n.fill,stroke:"#475569"}));
      }

      const t=elNS("text",{x:n.x+n.w/2,y:n.y+n.h/2,"text-anchor":"middle","dominant-baseline":"middle",fill:"var(--text)"});
      t.textContent=n.label; g.appendChild(t);
      updateEdges();
    }

    // ---------- Aristas ----------
    function addEdge(from,to){ if(!from||!to||from===to) return; state.edges.push({id:uuid("e"),from,to}); updateEdges(); }
    function updateEdges(){
      gEdges.innerHTML="";
      for(const e of state.edges){
        const a=state.nodes.find(n=>n.id===e.from), b=state.nodes.find(n=>n.id===e.to);
        if(!a||!b) continue;
        const A={x:a.x+a.w/2,y:a.y+a.h/2}, B={x:b.x+b.w/2,y:b.y+b.h/2};
        gEdges.appendChild(elNS("path",{
          d:`M${A.x},${A.y} C${A.x+(B.x-A.x)*0.4},${A.y} ${B.x-(B.x-A.x)*0.4},${B.y} ${B.x},${B.y}`,
          fill:"none",stroke:"#475569","stroke-width":2,"marker-end":"url(#arrow)"
        }));
      }
    }

    // ---------- Drag ----------
    let drag=null;
    function startDrag(e,n){ if(e.button!==0) return;
      const pt=getSVGPoint(e);
      drag={id:n.id,startX:pt.x,startY:pt.y,origX:n.x,origY:n.y};
      window.addEventListener("mousemove",onDrag);
      window.addEventListener("mouseup",endDrag);
    }
    function onDrag(e){
      if(!drag) return;
      const pt=getSVGPoint(e), dx=pt.x-drag.startX, dy=pt.y-drag.startY;
      const n=state.nodes.find(nn=>nn.id===drag.id);
      n.x=drag.origX+dx; n.y=drag.origY+dy; drawNode(n);
    }
    function endDrag(){ drag=null; window.removeEventListener("mousemove",onDrag); }

    // ---------- Editar texto ----------
    function startEdit(n){
      const b=document.getElementById(n.id).getBBox();
      inlineEdit.style.left=(b.x+b.width/2-60)+"px";
      inlineEdit.style.top=(b.y+b.height/2-10)+"px";
      inlineEdit.style.display="block";
      inlineEdit.value=n.label; inlineEdit.focus();
      inlineEdit.onblur=()=>{ n.label=inlineEdit.value||n.label; inlineEdit.style.display="none"; drawNode(n); };
      inlineEdit.onkeydown=(ev)=>{ if(ev.key==="Enter") inlineEdit.blur(); };
    }

    // ---------- Menú contextual (FIX: sin paréntesis extra) ----------
    function showCtx(e,n){ e.preventDefault(); ctxTarget=n; ctx.style.display="block"; ctx.style.left=e.clientX+"px"; ctx.style.top=e.clientY+"px"; }
    window.addEventListener("click",()=>ctx.style.display="none");
    document.getElementById("ctxEdit").onclick = ()=>ctxTarget&&startEdit(ctxTarget);
    document.getElementById("ctxColor").onclick= ()=>{ if(ctxTarget){ const c=prompt("Color HEX o nombre",ctxTarget.fill); if(c){ ctxTarget.fill=c; drawNode(ctxTarget); } } };
    document.getElementById("ctxDup").onclick  = ()=>ctxTarget&&addNode(ctxTarget.type,ctxTarget.x+30,ctxTarget.y+30,ctxTarget.label+" copia");
    document.getElementById("ctxDelete").onclick=()=>{ if(ctxTarget){ state.nodes=state.nodes.filter(n=>n.id!==ctxTarget.id); document.getElementById(ctxTarget.id)?.remove(); state.edges=state.edges.filter(e=>e.from!==ctxTarget.id&&e.to!==ctxTarget.id); updateEdges(); } };
    document.getElementById("ctxConnect").onclick=()=>{ state.connectMode=true; state.connectFrom=ctxTarget.id; document.getElementById("connectBtn").classList.add("primary"); };

    // ---------- Conectar ----------
    document.getElementById("connectBtn").onclick=()=>{ state.connectMode=!state.connectMode; state.connectFrom=null; document.getElementById("connectBtn").classList.toggle("primary",state.connectMode); };
    svg.addEventListener("mouseup",(e)=>{ if(!state.connectMode||!state.connectFrom) return; const g=e.target.closest("g"); if(g&&g.id!==state.connectFrom){ addEdge(state.connectFrom,g.id); state.connectMode=false; state.connectFrom=null; document.getElementById("connectBtn").classList.remove("primary"); } });

    // ---------- Añadir nodos desde la barra ----------
    document.querySelectorAll("[data-add]").forEach(b=>b.addEventListener("click",()=>addNode(b.dataset.add,100+Math.random()*220,100+Math.random()*160)));

    // ---------- Exportar / Importar ----------
    function download(filename,text){ const a=document.createElement("a"); a.href="data:text/plain;charset=utf-8,"+encodeURIComponent(text); a.download=filename; a.click(); }
    document.getElementById("exportJSON").onclick=()=>download("diagram.json",JSON.stringify(state));
    document.getElementById("importJSON").onclick=()=>{ const i=document.createElement("input"); i.type="file"; i.onchange=e=>{ const f=e.target.files[0]; const r=new FileReader(); r.onload=()=>{ const d=JSON.parse(r.result); state.nodes=d.nodes||[]; state.edges=d.edges||[]; state.idSeq=d.idSeq||1; gNodes.innerHTML=""; gEdges.innerHTML=""; state.nodes.forEach(drawNode); updateEdges(); }; r.readAsText(f); }; i.click(); };
    document.getElementById("exportSVG").onclick=()=>download("diagram.svg",new XMLSerializer().serializeToString(svg));
    document.getElementById("exportPNG").onclick=()=>{
      const xml=new XMLSerializer().serializeToString(svg), img=new Image();
      img.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(xml)));
      img.onload=()=>{ const c=document.createElement("canvas"); c.width=svg.clientWidth; c.height=svg.clientHeight; const ctx2=c.getContext("2d"); ctx2.fillStyle=getComputedStyle(document.body).getPropertyValue("--bg"); ctx2.fillRect(0,0,c.width,c.height); ctx2.drawImage(img,0,0); c.toBlob(b=>{ const a=document.createElement("a"); a.download="diagram.png"; a.href=URL.createObjectURL(b); a.click(); },"image/png"); };
    };

    // ---------- Helper fetch robusto ----------
    async function fetchJSON(url, opts){
      const res  = await fetch(url, opts || {});
      const text = await res.text();
      const ct   = res.headers.get("content-type") || "";
      if (!ct.includes("application/json")) throw new Error(text.slice(0,200));
      const j = JSON.parse(text);
      if (!res.ok || j.success === false) throw new Error(j.error || res.statusText);
      return j;
    }

    async function loadFromServer(){
      try{
        const j = await fetchJSON(`/api/negocios/${NEGOCIO_ID}/diagrama`, {credentials:'same-origin'});
        const d = j.data || {};
        Object.assign(state, { nodes:d.nodes||[], edges:d.edges||[], idSeq:d.idSeq||1 });
        gNodes.innerHTML=""; gEdges.innerHTML=""; state.nodes.forEach(drawNode); updateEdges();
      }catch(e){ console.warn("Sin diagrama previo o error al cargar:", e.message); }
    }

    async function saveToServer(){
      const btn = document.getElementById('saveCloud');
      btn.disabled = true; btn.textContent = 'Guardando...';
      try{
        await fetchJSON(`/api/negocios/${NEGOCIO_ID}/diagrama`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify({ data: state })
        });
        btn.textContent = '✅ Guardado';
        setTimeout(()=>{ btn.textContent='💾 Guardar diagrama'; btn.disabled=false; }, 900);
      }catch(e){
        btn.textContent='💾 Guardar diagrama'; btn.disabled=false;
        alert('Error al guardar: '+e.message);
      }
    }

    document.getElementById('saveCloud').addEventListener('click', saveToServer);
    loadFromServer();

    // ---------- Modo oscuro ----------
    const toggle=document.getElementById("toggleMode");
    toggle.onclick=()=>{ document.body.classList.toggle("dark"); toggle.textContent=document.body.classList.contains("dark")?"☀️ Modo claro":"🌙 Modo oscuro"; };
  </script>
</body>
</html>
